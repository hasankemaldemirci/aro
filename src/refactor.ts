import fs from "fs";
import path from "path";
import fg from "fast-glob";
import { Branding } from "./constants";
import { loadIgnoreList } from "./utils";

/**
 * @aro-context-marker
 * AI READABILITY NOTE: Performance Optimized Refactor Module.
 * Using fast-glob for rapid complexity detection.
 */

export async function run() {
  const projectPath = process.cwd();
  const contextPath = path.join(projectPath, ".agent_context_pro.json");
  const ignoreList = loadIgnoreList(projectPath);

  if (!fs.existsSync(contextPath)) {
    console.log(
      Branding.error(
        "‚ùå Error: No .agent_context_pro.json found. Run analysis first.",
      ),
    );
    process.exit(1);
  }

  const data = JSON.parse(fs.readFileSync(contextPath, "utf8"));
  const metrics = data.metrics;

  console.log(
    Branding.magenta.bold(
      "\nüõ†Ô∏è  ARO Auto-Refactor: Commencing Optimization...",
    ),
  );

  // 1. Documentation Optimization
  if (!metrics.hasReadme) {
    console.log(Branding.warning("üìù Generating missing README.md..."));
    const baseReadme = `# ${data.projectName}\n\n## Overview\nThis project is a ${data.framework} application.\n\n## Architecture\n*(Auto-generated by ARO)*\nThis project uses a standard ${data.framework} structure.`;
    fs.writeFileSync(path.join(projectPath, "README.md"), baseReadme);
    console.log(Branding.success("‚úÖ README.md created."));
  }

  // 2. Configuration Recovery
  const requiredConfigs: Record<string, string> = {
    ".env.example":
      "# Environment variables template\nPORT=3000\nAPI_" + "KEY=your_key_here",
    "tsconfig.json":
      '{\n  "compilerOptions": {\n    "target": "es5",\n    "module": "commonjs",\n    "strict": true\n  }\n}',
    ".gitignore": "node_modules\n.DS_Store\n.env\n.agent_context_pro.json",
  };

  for (const [file, content] of Object.entries(requiredConfigs)) {
    if (!fs.existsSync(path.join(projectPath, file))) {
      console.log(
        Branding.warning(`üõ†Ô∏è  Recovering missing config: ${file}...`),
      );
      fs.writeFileSync(path.join(projectPath, file), content);
      console.log(Branding.success(`‚úÖ ${file} generated.`));
    }
  }

  // 3. AI World Map Generation (Compensation for High-Complexity)
  if (!metrics.hasAIMap) {
    console.log(
      Branding.warning("üó∫Ô∏è  Generating AI World Map (AI-CONSTITUTION.md)..."),
    );
    const techStack = data.techStack.join(", ");
    const structure = JSON.stringify(data.structure, null, 2);

    const constitution = `# AI Constitution & Project World Map
      
> Optimized for Cursor, Windsurf, and Devin.

## Project DNA
- **Framework:** ${data.framework}
- **Tech Stack:** ${techStack}
- **Entry Points:** ${data.entryPoints.join(", ")}

## Navigation Guide
This map provides a visual traversal guide for AI Agents to prevent context truncation.

\`\`\`json
${structure}
\`\`\`

## AI Readability Rules
1. **Context First:** Always read .agent_context_pro.json before starting tasks.
2. **Small Files:** Preference for files < 300 lines.
3. **SEO Markers:** Respect @aro-context-marker notes in complex files.

---
*Generated by Agent ARO - AI Readability Optimizer*
`;
    fs.writeFileSync(
      path.join(projectPath, "AI-CONSTITUTION.md"),
      constitution,
    );
    console.log(Branding.success("‚úÖ AI-CONSTITUTION.md generated."));
  }

  // 4. Complexity Optimization: AI-SEO Markers (Optimized Scan)
  const filesToOptimize = fg.sync(["**/*.{js,ts,tsx,jsx}"], {
    cwd: projectPath,
    ignore: ignoreList.map((i) => `**/${i}/**`),
    absolute: true,
    deep: 5,
  });

  for (const file of filesToOptimize) {
    const content = fs.readFileSync(file, "utf8");
    if (content.split("\n").length > 100) {
      optimizeFile(file);
    }
  }

  console.log(
    Branding.success(
      "\n‚ú® Refactoring Pass Complete. Run ARO again to see updated scores!",
    ),
  );
}

function optimizeFile(filePath: string) {
  try {
    let content = fs.readFileSync(filePath, "utf8");
    if (content.includes("@aro-context-marker")) return;

    const lines = content.split("\n");
    let extraNote = "";

    if (lines.length > 300) {
      extraNote =
        "\n * CRITICAL: This file exceeds 300 lines. AI Agents may experience context truncation.\n * ACTION: Consider refactoring core logic into smaller sub-modules.";
      console.log(
        Branding.warning(
          `‚ö†Ô∏è  Self-Healing: Detected high-complexity in ${path.basename(filePath)} (${lines.length} lines). Applying advisory markers.`,
        ),
      );
    } else {
      console.log(
        Branding.gray(
          `üìå Adding AI-SEO markers to: ${path.basename(filePath)}`,
        ),
      );
    }

    const marker = `/**\n * @aro-context-marker\n * AI READABILITY NOTE: This file is monitored for AI-Readability.${extraNote}\n */\n`;

    if (lines[0].startsWith("#!")) {
      lines.splice(1, 0, marker);
      fs.writeFileSync(filePath, lines.join("\n"));
    } else {
      fs.writeFileSync(filePath, marker + content);
    }
  } catch (e) {}
}

if (require.main === module) {
  run();
}
